name: "Composite Action"
description: "Composite Action Template"
author: "Shane"

branding:
  icon: "type"
  color: "green"

# DO NOT EDIT ABOVE

inputs:
  version:
    description: "Actionlint Version Tag"
    default: "latest"
  arguments:
    description: "Command Line Arguments"
  shellcheck_opts:
    description: "Shellcheck Options"
  arch:
    description: "Architecture String"
  checkout:
    description: "Checkout Project"
    default: "false"
  summary:
    description: "Add Job Summary"
    default: "true"

outputs:
  download_url:
    description: "Actionlint Download URL"
    value: ${{ steps.install.outputs.browser_download_url }}

runs:
  using: "composite"
  steps:
    - name: "Checkout"
      if: ${{ inputs.checkout == 'true' }}
      uses: actions/checkout@v6

    - name: "Architecture"
      id: arch
      shell: bash
      run: |
        echo "::group::Parsing Architecture"

        if [ -n "${{ inputs.arch }}" ];then
          echo "arch=${{ inputs.arch }}" >> "$GITHUB_OUTPUT"
        else
          uname -a

          echo "uname -s: $(uname -s)"
          kernel=$(uname -s)
          case "$kernel" in
            Darwin)   kernel="darwin"   ;;
            FreeBSD)  kernel="freebsd"  ;;
            Linux)    kernel="linux"    ;;
            * )       kernel="linux"    ;;
          esac
          echo "kernel: ${kernel}"

          echo "uname -m: $(uname -m)"
          hardware=$(uname -m)
          case "$hardware" in
            x86)      hardware="amd386"  ;;
            i?86)     hardware="amd386"  ;;
            amd64)    hardware="amd64"   ;;
            x86_64)   hardware="amd64"   ;;
            aarch64)  hardware="arm64"   ;;
            * )       hardware="amd64"   ;;
          esac
          echo "hardware: ${hardware}"

          echo "arch: ${kernel}_${hardware}"
          echo "arch=${kernel}_${hardware}" >> "$GITHUB_OUTPUT"
        fi
        echo "::endgroup::"

    - name: "Install"
      id: install
      env:
        GH_TOKEN: ${{ github.token }}
      shell: bash
      run: |
        echo "Parsing Version"
        #echo "arch: ${{ steps.arch.outputs.arch }}"

        if [ "${{ inputs.version }}" == "latest" ];then
          tag="latest"
        else
          tag="tags/${{ inputs.version }}"
        fi
        #echo "tag: ${tag}"

        echo "::group::Release - ${tag}"
        release="$(gh api --cache 1h /repos/rhysd/actionlint/releases/${tag})"
        echo -n "tag_name: " ; echo ${release} | jq -r '.tag_name'
        echo "release: ${release}"
        echo "::endgroup::"

        echo "::group::Asset - ${{ steps.arch.outputs.arch }}"
        asset="$(echo ${release} |\
          jq '[.assets[] | select(.name | contains("${{ steps.arch.outputs.arch }}"))]' |\
          jq '.[0]')"
        echo "asset: ${asset}"
        echo "::endgroup::"

        url="$(echo ${asset} | jq -r '.browser_download_url')"
        echo "url: ${url}"

        echo "browser_download_url=${url}" >> "$GITHUB_OUTPUT"
        echo "::endgroup::"

        echo "Downloading Actionlint: ${RUNNER_TEMP}/actionlint"
        curl -L "${url}" | tar xz -C "${RUNNER_TEMP}" actionlint
        file "${RUNNER_TEMP}/actionlint" ||:
        "${RUNNER_TEMP}/actionlint" --version

    - name: "Actionlint"
      id: actionlint
      env:
        SHELLCHECK_OPTS: ${{ inputs.shellcheck_opts }}
      shell: bash
      run: |
        "${RUNNER_TEMP}/actionlint" -color -verbose ${{ inputs.arguments }}

    #- name: "Summary"
    #  if: ${{ always() && inputs.summary == 'true' }}
    #  continue-on-error: true
    #  shell: bash
    #  run: |
    #    markdown="# Zensical Action\n\n"
    #    markdown+="zensical version: \`${version}\`\n\n"
    #    if [ "${{ steps.actionlint.outcome }}" == "success" ];then
    #      markdown+="✅ Build Success\n\n"
    #    else
    #      markdown+="⛔ Build Failure\n\n"
    #    fi
    #    if [ -d "${path}" ];then
    #      markdown+="<details><summary>Build Tree</summary>\n\n\`\`\`text\n"
    #      markdown+="$(tree ${path} || ls -lAhR ${path} 2>&1 ||:)\n"
    #      markdown+="\`\`\`\n\n</details>\n\n"
    #    else
    #      markdown+="⛔ Path Not Found: ${path}\n\n"
    #    fi
    #    markdown+="---\n\n"
    #    echo -e "${markdown}" >> $GITHUB_STEP_SUMMARY
